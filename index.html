<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RFSoC Offloading Parametric Calculator (Updated)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { padding: 1.5rem; background:#f7f9fc; font-family: Arial, sans-serif;}
.card { box-shadow: 0 6px 18px rgba(15,23,42,0.08); }
.small { font-size:0.9rem; color:#444; }
input[type=number] { max-width: 220px; }
.result-box { background: #fff; padding: 1rem; border-radius: 8px; }
.badge-note { background:#eef2ff; padding:0.25rem 0.5rem; border-radius:6px; color:#1f2a8a; font-weight:600; }
</style>
</head>
<body>
<div class="container">
  <h2>RFSoC Offloading Parametric Calculator — Fleet-aware</h2>
  <p class="small">Updated defaults aim for realistic per-site parameters to illustrate network-level impact. This tool computes per-unit and fleet-level energy, OPEX and CO₂ savings over the equipment lifetime.</p>
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card p-3">
        <h5>Power & Performance (per unit)</h5>
        <div class="mb-2">
          <label class="form-label">P_PL_static (W)</label>
          <input id="p_pl_static" class="form-control" type="number" step="0.1" value="8.0">
          <div class="small">Baseline PL fabric static draw (W)</div>
        </div>
        <div class="mb-2">
          <label class="form-label">P_PL_fft_active (W)</label>
          <input id="p_pl_fft" class="form-control" type="number" step="0.1" value="6.0">
          <div class="small">Active PL FFT kernel (W)</div>
        </div>
        <div class="mb-2">
          <label class="form-label">P_PS_static (W)</label>
          <input id="p_ps_static" class="form-control" type="number" step="0.1" value="2.0">
          <div class="small">PS baseline idle draw (A53 cores + memory) (W)</div>
        </div>
        <div class="mb-2">
          <label class="form-label">P_PS_fft_active (W)</label>
          <input id="p_ps_fft" class="form-control" type="number" step="0.1" value="3.0">
          <div class="small">PS active FFT processing draw (W)</div>
        </div>
        <h5 class="mt-3">Workload & Switching</h5>
        <div class="mb-2">
          <label class="form-label">H_high (hours/day)</label>
          <input id="h_high" class="form-control" type="number" step="0.1" value="6.0">
        </div>
        <div class="mb-2">
          <label class="form-label">H_low (hours/day)</label>
          <input id="h_low" class="form-control" type="number" step="0.1" value="18.0">
        </div>
        <div class="mb-2">
          <label class="form-label">E_sw (J per switch)</label>
          <input id="e_sw" class="form-control" type="number" step="1" value="2000">
          <div class="small">Energy cost of one switch (J). Lower values reflect partial reconfiguration optimisations.</div>
        </div>
        <div class="mb-2">
          <label class="form-label">n_sw/day (switches per day)</label>
          <input id="n_sw" class="form-control" type="number" step="1" value="1">
        </div>
        <h5 class="mt-3">Economics & Fleet</h5>
        <div class="mb-2">
          <label class="form-label">Electricity price (€/kWh)</label>
          <input id="c_elec" class="form-control" type="number" step="0.001" value="0.25">
        </div>
        <div class="mb-2">
          <label class="form-label">Grid CO2 intensity (kgCO2/kWh)</label>
          <input id="i_grid" class="form-control" type="number" step="0.01" value="0.30">
        </div>
        <div class="mb-2">
          <label class="form-label">Lifetime (years)</label>
          <input id="t_life" class="form-control" type="number" step="1" value="10">
        </div>
        <div class="mb-2">
          <label class="form-label">Number of deployed units (fleet size)</label>
          <input id="fleet_size" class="form-control" type="number" step="1" value="1000">
          <div class="small">Multiply per-unit savings to estimate fleet impact.</div>
        </div>
        <div class="d-grid gap-2 mt-3">
          <button id="computeBtn" class="btn btn-primary">Compute</button>
          <button id="resetBtn" class="btn btn-outline-secondary">Reset to defaults</button>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3 result-box">
        <h5>Results (per unit and fleet)</h5>
        <div id="resultsArea">
          <p class="small">Adjust inputs and press Compute to see per-day, per-unit, and fleet-level estimates.</p>
        </div>
        <canvas id="chart" height="220"></canvas>
      </div>
    </div>
  </div>

  <footer class="mt-4 small">This is an estimator for order-of-magnitude analysis. For production planning, use measured per-kernel power profiles and validated forecasts.</footer>
</div>

<script>
function kWh_from_J(j) { return j/3600000; }

function compute() {
  const p_pl_static = parseFloat(document.getElementById('p_pl_static').value);
  const p_pl_fft = parseFloat(document.getElementById('p_pl_fft').value);
  const p_ps_static = parseFloat(document.getElementById('p_ps_static').value);
  const p_ps_fft = parseFloat(document.getElementById('p_ps_fft').value);
  const h_high = parseFloat(document.getElementById('h_high').value);
  const h_low = parseFloat(document.getElementById('h_low').value);
  const e_sw = parseFloat(document.getElementById('e_sw').value);
  const n_sw = parseFloat(document.getElementById('n_sw').value);
  const c_elec = parseFloat(document.getElementById('c_elec').value);
  const i_grid = parseFloat(document.getElementById('i_grid').value);
  const t_life = parseFloat(document.getElementById('t_life').value);
  const fleet_size = parseInt(document.getElementById('fleet_size').value) || 1;

  // Baseline: FFT in PL always (simplified)
  const baseline_power_day_W = p_pl_static + p_pl_fft; // average instantaneous power assumed constant across day for simplicity
  const baseline_kWh_day = baseline_power_day_W * 24 / 1000;

  // Dynamic: FFT in PL during H_high, in PS during H_low
  const dynamic_power_sum = (p_pl_static + p_pl_fft) * h_high + (p_ps_static + p_ps_fft) * h_low;
  const dynamic_avg_power_W = dynamic_power_sum / 24;
  const dynamic_kWh_day_compute = dynamic_avg_power_W * 24 / 1000;

  // Switching energy (J) per day converted to kWh
  const sw_kWh_day = kWh_from_J(e_sw * n_sw);

  const dynamic_kWh_day = dynamic_kWh_day_compute + sw_kWh_day;

  // Per-unit daily delta and lifecycle
  const delta_kWh_day = baseline_kWh_day - dynamic_kWh_day;
  const delta_kWh_life = delta_kWh_day * 365 * t_life;
  const delta_cost_life = delta_kWh_life * c_elec;
  const delta_CO2_life = delta_kWh_life * i_grid;

  // Fleet level
  const fleet_delta_kWh_life = delta_kWh_life * fleet_size;
  const fleet_delta_cost_life = delta_cost_life * fleet_size;
  const fleet_delta_CO2_life = delta_CO2_life * fleet_size;

  const results = {
    baseline_kWh_day, dynamic_kWh_day, delta_kWh_day,
    delta_kWh_life, delta_cost_life, delta_CO2_life,
    fleet_delta_kWh_life, fleet_delta_cost_life, fleet_delta_CO2_life,
    params: {p_pl_static,p_pl_fft,p_ps_static,p_ps_fft,h_high,h_low,e_sw,n_sw,c_elec,i_grid,t_life,fleet_size}
  };

  displayResults(results);
  renderChart(results);
  showWarningIfNegative(results.delta_kWh_day);
}

function displayResults(r) {
  const el = document.getElementById('resultsArea');
  el.innerHTML = `
    <p><strong>Baseline daily energy (kWh/unit):</strong> ${r.baseline_kWh_day.toFixed(3)}</p>
    <p><strong>Dynamic daily energy (kWh/unit):</strong> ${r.dynamic_kWh_day.toFixed(3)}</p>
    <p><strong>Estimated daily energy saved (kWh/unit):</strong> ${r.delta_kWh_day.toFixed(3)}</p>
    <hr/>
    <p><strong>Lifetime energy saved (kWh/unit):</strong> ${r.delta_kWh_life.toFixed(1)}</p>
    <p><strong>Lifetime OPEX saved (EUR/unit):</strong> €${r.delta_cost_life.toFixed(2)}</p>
    <p><strong>Lifetime CO₂ avoided (kg/unit):</strong> ${r.delta_CO2_life.toFixed(1)} kgCO₂</p>
    <hr/>
    <p><strong>Fleet lifetime energy saved (kWh):</strong> ${r.fleet_delta_kWh_life.toLocaleString(undefined,{maximumFractionDigits:0})}</p>
    <p><strong>Fleet lifetime OPEX saved (EUR):</strong> €${r.fleet_delta_cost_life.toLocaleString(undefined,{maximumFractionDigits:0})}</p>
    <p><strong>Fleet lifetime CO₂ avoided (kg):</strong> ${r.fleet_delta_CO2_life.toLocaleString(undefined,{maximumFractionDigits:0})} kgCO₂</p>
  `;
}

let chartInstance = null;
function renderChart(r) {
  const ctx = document.getElementById('chart').getContext('2d');
  const labels = ['Baseline (kWh/day/unit)', 'Dynamic (kWh/day/unit)', 'Saved (kWh/day/unit)'];
  const data = [r.baseline_kWh_day, r.dynamic_kWh_day, Math.max(0, r.delta_kWh_day)];
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{ label: 'Energy (kWh/day/unit)', data: data }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
}

function showWarningIfNegative(delta_kWh_day) {
  const el = document.getElementById('resultsArea');
  // Remove existing alert(s)
  const existing = el.querySelectorAll('.alert');
  existing.forEach(e => e.remove());
  if (delta_kWh_day < 0) {
    el.insertAdjacentHTML('afterbegin', `<div class="alert alert-warning"><strong>Warning:</strong> Estimated daily energy saved is negative — current offloading configuration increases energy consumption per unit. Consider adjusting parameters or reducing switching frequency.</div>`);
  }
}

document.getElementById('computeBtn').addEventListener('click', compute);
document.getElementById('resetBtn').addEventListener('click', function(){
  document.getElementById('p_pl_static').value = 8.0;
  document.getElementById('p_pl_fft').value = 6.0;
  document.getElementById('p_ps_static').value = 2.0;
  document.getElementById('p_ps_fft').value = 3.0;
  document.getElementById('h_high').value = 6.0;
  document.getElementById('h_low').value = 18.0;
  document.getElementById('e_sw').value = 2000;
  document.getElementById('n_sw').value = 1;
  document.getElementById('c_elec').value = 0.25;
  document.getElementById('i_grid').value = 0.30;
  document.getElementById('t_life').value = 10;
  document.getElementById('fleet_size').value = 1000;
  document.getElementById('resultsArea').innerHTML = '<p class="small">Adjust inputs and press Compute to see per-day, per-unit, and fleet-level estimates.</p>';
  if (chartInstance) chartInstance.destroy();
});
</script>
</body>
</html>
